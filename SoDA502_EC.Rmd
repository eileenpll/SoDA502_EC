---
title: "SoDA 502 Emotional Contagion"
output: html_notebook
---

1. Emotion Detection
```{r}
#setwd("/Users/Charlotte/Desktop/Fall 2018/SoDA 502/Emotional Contagion")

#install.packages(c("readr","jsonlite","plyr","dplyr","tidyr","tidytext"))
library(readr)
library(jsonlite)
library(plyr)
library(dplyr)
library(tidyr)
library(tidytext)

## function that converts multiple json to df
json2df <- function(string) {
    lst <- head(
            strsplit(
                    gsub('\\}}\n','\\}}x!x!', string),'x!x!')[[1]],-1) %>%
            as.list()
    # replace the line below to ~ for the ease of testing code
    # df <- lapply(lst[1:100],fromJSON)
    df <- lapply(lst, fromJSON) %>%
            lapply(., function(x) {
                x[sapply(x, is.null)] <- NA; unlist(x)}) %>%
            lapply(., function(x) {
                do.call("data.frame", as.list(x))}
                ) %>%
            rbind.fill() %>%
            tibble::rowid_to_column("ID")
    return(df)
    }

# credit to https://gist.github.com/CateGitau/05e6ff80b2a3aaa58236067811cee44e
# clean tweets
cleanedText <- function(x) {
    x<-gsub("http[[:alnum:][:punct:]]*", "", x)  ## Remove URLs
    x<-gsub('\\b+RT', '', x) ## Remove RT
    x<-gsub('#\\S+', '', x) ## Remove Hashtags
    x<-gsub('@\\S+', '', x) ## Remove Mentions
    x<-gsub('[[:cntrl:]]', '', x) ## Remove Controls and special characters
    x<-gsub("\\d", '', x) ## Remove Controls and special characters
    x<-gsub('[[:punct:]]', '', x) ## Remove Punctuations
    x<-gsub("^[[:space:]]*","",x) ## Remove leading whitespaces
    x<-gsub("[[:space:]]*$","",x) ## Remove trailing whitespaces
    x<-gsub(' +',' ',x) ## Remove extra whitespaces
    return(x)
    }

EmotionDetection <- function(df) {
    # tokenize text
    df.token <- df %>%
        select(c("ID","text")) %>%
        mutate(text = as.character(text)) %>%
        mutate(
            text = cleanedText(text)
        ) %>%
        unnest_tokens(word, text)
    # sentiment analysis
    df.sentiment <- df.token %>%
        inner_join(get_sentiments("nrc"), by = "word") %>%
        filter(sentiment %in% c("fear","anger","sadness",
                                "disgust", "negative")) %>%
        group_by(ID,sentiment) %>%
        dplyr::summarise(count=n()) %>%
        # long to wide
        spread(sentiment,count,fill = 0) %>%
        .[c("ID","anger","disgust","fear","sadness","negative")] %>%
        mutate(
            anger_binary = ifelse(anger>0,1,0),
            disgust_binary = ifelse(disgust>0,1,0),
            fear_binary = ifelse(fear>0,1,0),
            sadness_binary = ifelse(sadness>0,1,0),
            negative_binary = ifelse(negative>0,1,0)
        )
    }

fileName <- "tm_tweets_merge.txt"
string <- read_file(fileName)
df <- json2df(string)

df.subset <- df %>%
    dplyr::select(c("ID", "text","retweet_count","favorite_count",
             "user.followers_count","user.location",
             "user.description","user.friends_count",
             "coordinates.coordinates1","coordinates.coordinates2",
             "created_at","place.full_name","place.name")
           ) %>%
    plyr::rename(c("coordinates.coordinates1"="long",
             "coordinates.coordinates2"="lat",
             "user.followers_count"="followers",
             "user.friends_count"="friends")) %>%
    mutate(lat = as.numeric(levels(lat))[lat],
           long = as.numeric(levels(long))[long],
           time = as.POSIXct(
               created_at, tz = "GMT", format = "%a %b %e %H:%M:%S %z %Y")
           ) 
    
df.emotion <- EmotionDetection(df.subset) %>%
    left_join(df.subset,., by = "ID") 
df.emotion[is.na(df.emotion)] <- 0

save(df, df.emotion, file = "df_emotion.RData")
```

2. Mapping Emotions

```{r}
rm(list = ls())

#install.packages(c("ggmap","ggplot2","lubridate","maps"),quiet=TRUE)
library(lubridate)
library(maps)
#library(ggmap)
library(ggplot2)
library(dplyr)

load("df_emotion.RData")

# remove data from Alaska, Hawaii & Puerto Rico
df.emotion.map <- 
    df.emotion %>% 
    filter(long > -130 & lat < 50 & lat > 20)

# create a variable indexing unique emotions
# e.g., a tweet is categorized into "fear" if it only contains the emotion "fear"
# ? any better ways to create such variable? the code below seems stupid.
####
df.emotion.map$emo_type <- NA
df.emotion.map[which(
    df.emotion.map$fear_binary > 0 & 
        df.emotion.map$sadness_binary == 0 & 
        df.emotion.map$disgust_binary == 0 & 
        df.emotion.map$anger_binary == 0),]$emo_type <- "fear"
df.emotion.map[which(
    df.emotion.map$fear_binary == 0 & 
        df.emotion.map$sadness_binary > 0 & 
        df.emotion.map$disgust_binary == 0 & 
        df.emotion.map$anger_binary == 0),]$emo_type <- "sadness"
df.emotion.map[which(
    df.emotion.map$fear_binary == 0 & 
        df.emotion.map$sadness_binary == 0 & 
        df.emotion.map$disgust_binary > 0 & 
        df.emotion.map$anger_binary == 0),]$emo_type <- "disgust"
df.emotion.map[which(
    df.emotion.map$fear_binary == 0 & 
        df.emotion.map$sadness_binary == 0 & 
        df.emotion.map$disgust_binary == 0 & 
        df.emotion.map$anger_binary > 0),]$emo_type <- "anger"
df.emotion.map[which(
    df.emotion.map$fear_binary == 0 & 
        df.emotion.map$sadness_binary == 0 & 
        df.emotion.map$disgust_binary == 0 & 
        df.emotion.map$anger_binary == 0),]$emo_type <- "none"
df.emotion.map[which(
    df.emotion.map$fear_binary +
        df.emotion.map$sadness_binary +
        df.emotion.map$disgust_binary +
        df.emotion.map$anger_binary > 1),]$emo_type <- "mixed"
df.emotion.map[which(
    df.emotion.map$emo_type == "none" & 
        df.emotion.map$negative_binary > 0),]$emo_type <- "negative"
####

# create a US basemap 
us_basemap <- ggplot() +
  borders(database = "state",regions = , colour = "gray85", fill = "gray80")

# any spatial temporal patterns of all tweets?
time1 <- as.numeric(df.emotion.map$time)
map_tweets <- 
    us_basemap + 
    geom_point(data = df.emotion.map, aes(
        x = long, y = lat, colour = time1),alpha = .5, size = 0.1) +
    scale_size_continuous(range = c(1, 8),
                          breaks = c(250, 500, 750, 1000)) +
    scale_colour_gradient2(low = "#3288bd", mid = "#fee08b", high = "#d53e4f", midpoint = median(time1, rm.na = TRUE)) +
    labs(title = "Tweet Locations after the Shooting of Trayvon Martin")
ggsave("map_tweets.pdf", width = 10, height = 7)

EmotionMap <- function(df, emotion, col_low = NA, col_high = NA) {
    df %>% dplyr::filter(emotion > 0)
    Emotion <- df[,emotion]
    map <- us_basemap + 
        geom_point(data = df, aes(
        x = long, y = lat,colour = Emotion), alpha = .5, size = 0.1) +
        scale_size_continuous(
            range = c(1, 8), breaks = c(250, 500, 750, 1000)) +
        scale_colour_gradient(
            low = ifelse(is.na(col_low),"#3288bd", col_low), 
                              high = ifelse(
                                  is.na(col_high),"#d53e4f", col_high)) +
        labs(
            title = "Tweet Locations after the Shooting of Trayvon Martin")
    return(map)
    }

EmotionMap(df.emotion.map, "fear")

df.discrete.emo <- df.emotion.map %>% filter(!emo_type %in% c("mixed", "none", "negative"))

mapNegEmo <- us_basemap + 
        geom_point(data = df.discrete.emo, aes(
        x = long, y = lat,colour = emo_type), alpha = .5, size = 1) +
        scale_size_continuous(
            range = c(1, 8), breaks = c(250, 500, 750, 1000)) +
        scale_colour_brewer(type = "qual", palette = "Set1")

```

